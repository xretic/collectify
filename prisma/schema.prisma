generator client {
    provider = "prisma-client"
    output   = "../generated/prisma"
}

datasource db {
    provider = "postgresql"
}

model User {
    id            Int            @id
    email         String         @unique
    passwordHash  String?
    avatarUrl     String         @default("")
    bannerUrl     String         @default("")
    username      String
    fullName      String
    description   String         @default("")
    githubId      String?        @unique
    googleId      String?        @unique
    createdAt     DateTime       @default(now())
    collections   Collection[]
    subscriptions Follow[]       @relation("Subscriptions")
    followers     Follow[]       @relation("Followers")
    notifications Notification[] @relation("ReceivedNotifications")
    Notification  Notification[]
    sessions      Session[]
    favorites     Collection[]   @relation("FavoriteCollections")
    Comment       Comment[]
    chats         Chat[]
    messages      Message[]
}

model Chat {
    id        Int       @id @default(autoincrement())
    createdAt DateTime  @default(now())
    users     User[]
    messages  Message[]
}

model Message {
    id              Int      @id @default(autoincrement())
    chatId          Int
    userId          Int
    recipientUserId Int
    content         String
    read            Boolean  @default(false)
    createdAt       DateTime @default(now())

    chat Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([chatId, createdAt])
    @@index([userId, createdAt])
}

model Notification {
    id              Int              @id @default(autoincrement())
    senderUserId    Int?
    recipientUserId Int
    createdAt       DateTime         @default(now())
    isRead          Boolean          @default(false)
    type            NotificationType
    collectionId    Int?
    collection      Collection?      @relation(fields: [collectionId], references: [id])
    recipientUser   User             @relation("ReceivedNotifications", fields: [recipientUserId], references: [id], onDelete: Cascade)
    senderUser      User?            @relation(fields: [senderUserId], references: [id], onDelete: Cascade)
}

model Follow {
    followerId  Int
    followingId Int
    follower    User @relation("Subscriptions", fields: [followerId], references: [id], onDelete: Cascade)
    following   User @relation("Followers", fields: [followingId], references: [id], onDelete: Cascade)

    @@id([followerId, followingId])
}

model Session {
    id        String   @id
    userId    Int
    expiresAt DateTime
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
}

model Collection {
    id              Int            @id @default(autoincrement())
    name            String
    lowerCaseName   String
    description     String         @default("")
    bannerUrl       String
    category        String
    userId          Int?
    createdAt       DateTime       @default(now())
    User            User?          @relation(fields: [userId], references: [id], onDelete: Cascade)
    items           Item[]
    likes           Like[]
    comments        Comment[]
    addedToFavorite User[]         @relation("FavoriteCollections")
    Notification    Notification[]
}

model Comment {
    id           Int        @id @default(autoincrement())
    User         User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
    userId       Int
    collectionId Int
    text         String
    Collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
    createdAt    DateTime   @default(now())
}

model Like {
    id           Int        @id @default(autoincrement())
    userId       Int
    collectionId Int
    Collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
}

model Item {
    id           Int         @id @default(autoincrement())
    title        String
    description  String
    collectionId Int?
    sourceUrl    String?
    imageUrl     String?
    order        Int
    Collection   Collection? @relation(fields: [collectionId], references: [id], onDelete: Cascade)

    @@index([collectionId, order])
}

enum NotificationType {
    FOLLOW
    LIKE
    COMMENT
    FAVORITE
}
